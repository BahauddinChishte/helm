---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import BlogCard from '../../components/BlogCard.astro';

const posts = (await getCollection('blog')).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

const topics = [
  'Agencies',
  'Analytics',
  'Blogging',
  'demo',
  'Entrepreneurship'
];

const contentTypes = [
  'E-books',
  'Webinars'
];
---

<Layout
  title="Resources - Helm Blog & Learning Center"
  description="Read insights, tips, and success stories about offshore staffing, team building, and business growth from the Helm team."
>
  <section class="relative pt-32 pb-32 bg-brand-navy overflow-hidden">
    <div class="absolute inset-0 z-0">
      <img
        src="/images/resources-page/resources-page-hero-background.webp"
        alt="Resources Background"
        class="w-full h-full object-cover opacity-40"
      />
      <div class="absolute inset-0 bg-brand-navy/40"></div>
    </div>
    <div class="relative z-10 w-full px-8 sm:px-12 lg:px-16">
      <div class="text-center">
        <h1 class="text-4xl sm:text-5xl font-bold text-white">
          Free Resources
        </h1>
      </div>
    </div>
  </section>

  <section class="pb-20 bg-gray-50 pt-8">
    <div class="w-full px-8 sm:px-12 lg:px-16">
      <div class="flex flex-col lg:flex-row gap-8">

        <aside class="lg:w-80 flex-shrink-0">
          <div class="bg-brand-navy rounded-lg p-8 sticky top-24 shadow-lg">
            <div class="mb-8">
              <input
                type="text"
                id="search-input"
                placeholder="Search..."
                class="w-full px-4 py-3 rounded-md bg-white text-brand-navy placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-brand-orange text-sm"
              />
            </div>

            <div class="mb-8">
              <h3 class="text-white font-bold text-lg mb-4">
                Topics
              </h3>
              <div class="space-y-3">
                {topics.map((topic) => (
                  <label class="flex items-center gap-3 cursor-pointer group">
                    <input
                      type="checkbox"
                      class="topic-checkbox custom-checkbox w-5 h-5 rounded border-2 border-gray-300 bg-white checked:bg-white checked:border-white focus:ring-0 focus:ring-offset-0 cursor-pointer appearance-none"
                      data-filter={topic}
                      value={topic}
                    />
                    <span class="text-white text-base group-hover:text-gray-200 transition-colors">
                      {topic}
                    </span>
                  </label>
                ))}
              </div>
            </div>

            <div>
              <h3 class="text-white font-bold text-lg mb-4">
                Content Types
              </h3>
              <div class="space-y-3">
                {contentTypes.map((type) => (
                  <label class="flex items-center gap-3 cursor-pointer group">
                    <input
                      type="checkbox"
                      class="type-checkbox custom-checkbox w-5 h-5 rounded border-2 border-gray-300 bg-white checked:bg-white checked:border-white focus:ring-0 focus:ring-offset-0 cursor-pointer appearance-none"
                      data-filter={type}
                      value={type}
                    />
                    <span class="text-white text-base group-hover:text-gray-200 transition-colors">
                      {type}
                    </span>
                  </label>
                ))}
              </div>
            </div>
          </div>
        </aside>

        <main class="flex-1">
          <div class="mb-6 flex items-center justify-between">
            <p class="text-sm text-brand-slate">
              <span id="results-count" class="font-semibold text-brand-navy">{posts.length}</span> resource{posts.length !== 1 ? 's' : ''} found
            </p>
          </div>

          {posts.length > 0 ? (
            <div>
              <div id="blog-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                {posts.map((post) => (
                  <div class="blog-item h-full" data-tags={JSON.stringify(post.data.tags || [])} data-title={(post.data.title || '').toLowerCase()} data-description={(post.data.description || '').toLowerCase()}>
                    <a href={`/free-resources/${post.slug}/`} class="block group h-full">
                      <article class="bg-white rounded-2xl overflow-hidden shadow-lg hover:shadow-2xl transition-all duration-300 h-full flex flex-col">
                        <div class="overflow-hidden bg-gray-100 relative" style="height: 225px;">
                          {post.data.image && (
                            <img
                              src={post.data.image}
                              alt={post.data.title}
                              class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                              loading="lazy"
                            />
                          )}
                          <div class="absolute top-4 left-4">
                            {post.data.tags && post.data.tags.length > 0 && (
                              <span class="inline-block px-4 py-1.5 bg-yellow-400 text-brand-navy text-xs font-bold rounded shadow-sm">
                                {post.data.tags[post.data.tags.length - 1]}
                              </span>
                            )}
                          </div>
                        </div>
                        <div class="p-6 flex flex-col flex-1">
                          <h3 class="text-xl font-bold text-brand-navy mb-3 group-hover:text-brand-orange transition-colors leading-tight">
                            {post.data.title}
                          </h3>
                          <p class="text-sm text-gray-600 leading-relaxed">
                            {post.data.description}
                          </p>
                        </div>
                      </article>
                    </a>
                  </div>
                ))}
              </div>

              <div id="no-results" class="hidden text-center py-30">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-200 mb-4">
                  <svg class="w-8 h-8 text-brand-slate" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                  </svg>
                </div>
                <h3 class="text-xl font-bold text-brand-navy mb-2">
                  No resources found
                </h3>
                <p class="text-brand-slate mb-6">
                  Try adjusting your filters or search terms
                </p>
                <button
                  id="reset-filters"
                  class="inline-flex items-center gap-2 bg-brand-orange text-white px-6 py-2.5 rounded-lg font-medium hover:bg-brand-orangeDark transition-colors"
                >
                  Reset Filters
                </button>
              </div>
            </div>
          ) : (
            <div class="text-center py-20 bg-white rounded-2xl">
              <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-brand-light mb-4">
                <svg class="w-8 h-8 text-brand-orange" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                </svg>
              </div>
              <h3 class="text-xl font-bold text-brand-navy mb-2">
                Resources Coming Soon
              </h3>
              <p class="text-brand-slate">
                Check back later for insights and resources.
              </p>
            </div>
          )}
        </main>
      </div>
    </div>
  </section>
</Layout>

<style>
  .blog-item {
    animation: fadeIn 0.4s ease-out;
  }

  .blog-item.hidden {
    display: none;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .custom-checkbox {
    appearance: none;
    -webkit-appearance: none;
    display: inline-block;
    position: relative;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .custom-checkbox:checked::before {
    content: "âœ“";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #000;
    font-size: 14px;
    font-weight: bold;
    line-height: 1;
  }

  .custom-checkbox:focus {
    outline: none;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const topicCheckboxes = document.querySelectorAll('.topic-checkbox') as NodeListOf<HTMLInputElement>;
    const typeCheckboxes = document.querySelectorAll('.type-checkbox') as NodeListOf<HTMLInputElement>;
    const searchInput = document.getElementById('search-input') as HTMLInputElement;
    const blogItems = document.querySelectorAll('.blog-item');
    const blogGrid = document.getElementById('blog-grid');
    const noResults = document.getElementById('no-results');
    const resultsCount = document.getElementById('results-count');
    const clearFiltersBtn = document.getElementById('clear-filters');
    const resetFiltersBtn = document.getElementById('reset-filters');

    let activeTopics: string[] = [];
    let activeTypes: string[] = [];
    let searchTerm = '';

    function filterPosts() {
      let visibleCount = 0;

      blogItems.forEach((item) => {
        const tags = JSON.parse(item.getAttribute('data-tags') || '[]');
        const title = item.getAttribute('data-title') || '';
        const description = item.getAttribute('data-description') || '';

        const matchesSearch = !searchTerm ||
          title.includes(searchTerm.toLowerCase()) ||
          description.includes(searchTerm.toLowerCase());

        const matchesTopic = activeTopics.length === 0 ||
          activeTopics.some(topic => tags.includes(topic));

        const matchesType = activeTypes.length === 0 ||
          activeTypes.some(type => tags.includes(type));

        if (matchesSearch && matchesTopic && matchesType) {
          item.classList.remove('hidden');
          visibleCount++;
        } else {
          item.classList.add('hidden');
        }
      });

      if (resultsCount) {
        resultsCount.textContent = visibleCount.toString();
      }

      if (visibleCount === 0) {
        blogGrid?.classList.add('hidden');
        noResults?.classList.remove('hidden');
      } else {
        blogGrid?.classList.remove('hidden');
        noResults?.classList.add('hidden');
      }
    }

    function clearAllFilters() {
      activeTopics = [];
      activeTypes = [];
      searchTerm = '';

      topicCheckboxes.forEach(checkbox => checkbox.checked = false);
      typeCheckboxes.forEach(checkbox => checkbox.checked = false);
      if (searchInput) searchInput.value = '';

      filterPosts();
    }

    topicCheckboxes.forEach((checkbox) => {
      checkbox.addEventListener('change', () => {
        const filter = checkbox.getAttribute('data-filter') || '';
        if (checkbox.checked) {
          activeTopics.push(filter);
        } else {
          activeTopics = activeTopics.filter(t => t !== filter);
        }
        filterPosts();
      });
    });

    typeCheckboxes.forEach((checkbox) => {
      checkbox.addEventListener('change', () => {
        const filter = checkbox.getAttribute('data-filter') || '';
        if (checkbox.checked) {
          activeTypes.push(filter);
        } else {
          activeTypes = activeTypes.filter(t => t !== filter);
        }
        filterPosts();
      });
    });

    searchInput?.addEventListener('input', (e) => {
      searchTerm = (e.target as HTMLInputElement).value;
      filterPosts();
    });

    clearFiltersBtn?.addEventListener('click', clearAllFilters);
    resetFiltersBtn?.addEventListener('click', clearAllFilters);

    filterPosts();
  });
</script>
